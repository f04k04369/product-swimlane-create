# テスト設計書（Swimlane Studio）

## 1. テスト方針
- 状態管理ロジックとユーティリティはVitestで単体テストを実施する。
- UI操作と図形描画の主要フローはPlaywrightでE2Eテストを行う。
- Mermaidエクスポートおよび監査ログはスナップショットまたはサンプル`specs/`との比較で回帰を防ぐ。
- 重要な操作には監査ログ出力とUndo/Redo挙動の連携を確認する。

## 2. テスト範囲
| 区分 | 対象 | 備考 |
| --- | --- | --- |
| 単体テスト | `lib/diagram` レイアウト計算、Mermaid入出力、監査ユーティリティ | `npm run test` で実行 |
| 単体テスト | `state/useDiagramStore` のアクションと履歴管理 | Zustandのモックを使用 |
| 結合テスト | UIコンポーネントとストアの統合（エディタ主要操作） | Testing Libraryでレンダリング |
| E2Eテスト | レーン作成〜Mermaid/PNG出力、Undo/Redo、監査ログダウンロード | `npm run test:e2e` |
| 回帰チェック | `specs/` のMermaidファイルを手動比較 | 重要リリース前に実施 |

## 3. テストケース概要
| ID | レベル | シナリオ | 期待結果 | 自動化 |
| --- | --- | --- | --- | --- |
| TC-01 | 単体 | `addLane` 実行でレーンが追加され、色・順序が正規化される | 新レーンが末尾に追加、`selection.lanes` が更新 | ○（Vitest） |
| TC-02 | 単体 | `addStep` → `moveStep` → `reorderStep` | ステップ座標が `deriveStepX`/`yForRow` に従い整列し、行番号が更新される | ○（Vitest） |
| TC-03 | 単体 | `changeStepKind` | サイズ・デフォルト色が種別に応じて更新 | ○（Vitest） |
| TC-04 | 結合 | レーン追加→ステップ追加→Undo/Redo | 操作順にUndo/Redoが往復し、監査ログも記録 | ○（Vitest） |
| TC-05 | 結合 | Mermaidインポートのバリデーション | 不正ファイルでエラーメッセージ表示、状態不変 | ○（Testing Library） |
| TC-06 | E2E | レーン・ステップ編集→Mermaidエクスポート | モーダルにMermaidコードが表示され、ダウンロード可能 | ○（Playwright） |
| TC-07 | E2E | ステップ接続→ラベル編集→PNG出力 | エッジにラベルが表示され、PNGダウンロード完了トースト | ○（Playwright） |
| TC-08 | E2E | 監査ログダウンロード | JSONファイルが生成され、期待フィールドを含む | ○（Playwright） |
| TC-09 | 手動 | 大規模図（100ステップ）操作 | スクロール・ドラッグが遅延なく動作 | △（手動） |
| TC-10 | 手動 | 主要ブラウザ互換性 | Chrome/Edge/FirefoxでUI崩れなし | △（手動） |
| TC-11 | 結合 | 行番号を指定して空行を保持 | StepPanelで行番号を変更すると、キャンバス上でセルが詰められずに保持される | ○（Vitest/Testing Library） |
| TC-12 | E2E | 横方向接続 | 任意のステップの左右ハンドルから矢印を作成し、水平な場合は直線で描画される | ○（Playwright） |
| TC-13 | 手動 | 直角コネクタ表示確認 | 斜め接続はカギ線、水平・垂直は直線で終端には矢印が付与される | △（手動） |
| TC-14 | 結合 | ステップ上下移動の空行対応 | 空行がある場合は行番号を移動し、詰まっている場合は入れ替わる | ○（Vitest） |
| TC-15 | 結合 | コネクタ制御点のドラッグ | 制御点をドラッグすると折れ曲がり位置が保存され、再選択しても維持される | ○（Testing Library） |
| TC-16 | E2E | マーカー種別・サイズの変更 | 開始/終端マーカーを変更し、Mermaid出力でも設定が保持される | ○（Playwright） |
| TC-17 | 結合 | レーン高さの自動調整 | ステップ行数を増減するとレーン高さが動的に変化する | ○（Vitest） |
| TC-18 | 結合 | 任意ラベル入力 | 50文字以内のラベル入力・改行がコネクタとMermaid出力に反映される | ○（Testing Library） |
| TC-19 | E2E | Mermaid再インポート | エクスポート直後のMermaidコードを再インポートするとステップ配置・サイズ・コネクタ状態が一致する | ○（Playwright） |

## 4. テストデータ
- 初期状態: `createEmptyDiagram()` が生成する空のダイアグラム。
- サンプル: `specs/` 配下のMermaidファイルをインポートし、再エクスポートして差分を確認する。
- 監査ログ: ダミー操作で生成し、フィールド構造を検証する。

## 5. 実行タイミング
- `npm run test`: プルリク作成前およびCIで常時実行。
- `npm run test:e2e`: 主要機能改修時とリリース前リグレッションで実行。
- 手動テスト: UI大規模変更・React Flowアップデート時に実施。

## 6. 不具合報告・トリアージ
- バグ発生時は再現手順、期待結果、実際の結果、影響範囲、関連Mermaidファイルを添えてIssue登録。
- 監査ログやMermaid出力に破損があった場合は、該当ドキュメントと`docs/`の仕様変更箇所を更新する。

## 7. 保守指針
- テスト追加時は対象シナリオを上表に追記し、自動化可否を明記する。
- 既存テストが失敗した場合は仕様変更か不具合かを切り分け、本書と`specs/`の内容を同期する。
- CIでの検出率を高めるため、将来的にMermaid差分のスナップショットテストを導入することを検討する。
