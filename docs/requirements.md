# 要件定義書（Swimlane Studio）

## 1. プロジェクト概要
- ドラッグ＆ドロップで業務フローを作成できるスイムレーン図エディタを提供する。
- Webブラウザ上で動作し、Mermaid記法・PNG・監査ログのエクスポートに対応する。
- Next.js（App Router）とTypeScriptをベースに、React Flow・Zustand・Tailwind CSSを活用する。

## 2. 背景と目的
- 手作業でのフローチャート作成の手間と再利用性の低さを解消する。
- Mermaid互換のデータを生成し、他ツールとの連携とバージョン管理を容易にする。
- 操作履歴（監査証跡）を残し、業務プロセスの変更理由を追跡可能にする。

## 3. 利用者と利害関係者
- 企画・業務設計担当者: プロセス整理と共有のために利用。
- 情シス／開発チーム: Mermaid記法を活用したドキュメント管理、CIでの自動レンダリングに利用。
- 監査・品質管理担当: 監査ログを用いた変更履歴のレビュー。
- プロダクトチーム: 機能改善や要望を取りまとめる。

## 4. 利用シナリオ
- 新しい業務プロセスの初期設計をスピーディーに可視化し、レビュー会議で共有する。
- 既存のMermaidファイルをインポートし、ブラウザ上でレイアウトや属性を微調整する。
- エクスポートしたPNGをプレゼン資料やチケットに添付する。
- 操作ログをダウンロードし、監査証跡として保管する。

## 5. 機能要件
| 分類 | ID | 要件 | 優先度 | 備考 |
| --- | --- | --- | --- | --- |
| 編集 | FR-01 | レーンの追加・並び替え・削除ができる | MUST | 並び替えはドラッグまたは操作ボタンで実現 |
| 編集 | FR-02 | レーン内に各種ステップ（開始/終了/条件分岐/標準/ファイル）を追加・編集できる | MUST | サイズ・色・説明の編集を含む |
| 編集 | FR-03 | ステップの上下移動・ドラッグ移動・削除ができる | MUST | レーン内で整列位置を自動計算 |
| 接続 | FR-04 | ステップ間を矢印で接続し、分岐にはyes/noラベルを付与できる | SHOULD | 連続ステップは自動接続 |
| 状態 | FR-05 | Undo / Redo により最大50ステップ分の操作履歴を行き来できる | MUST | Zustandの履歴スタックを利用 |
| 入出力 | FR-06 | Mermaid記法（flowchart LR）でエクスポート・インポートできる | MUST | メタデータコメント `%% Swimlane Studio Export v1` を付与 |
| 入出力 | FR-07 | PNG画像をローカルに保存できる | MUST | html-to-image を利用し高解像度出力 |
| 入出力 | FR-08 | 操作監査ログをJSONでダウンロードできる | SHOULD | `action`/`targetType`/`payload` を含む |
| 表示 | FR-09 | レーン一覧・ステップ詳細パネルの開閉を切り替えられる | SHOULD | サイドバーの表示制御 |
| 表示 | FR-10 | ステータス通知（成功/エラー）を画面上部に表示し自動で消える | COULD | 4秒でフェードアウト |
| 表示 | FR-11 | コネクタは曲線ではなく直角（ステップ）スタイルで描画し、終端は矢印とする | MUST | 決定分岐の分岐矢印も含む |
| 編集 | FR-12 | 全ステップに左右の入出力ハンドルを配置し、横方向の接続を可能にする | MUST | ステップ種別に応じて入出力可否のみ制御 |
| レイアウト | FR-13 | レーンは行・列でグリッドに整列し、空行を保持できる | MUST | 行番号で制御し、空セルを維持 |
| 編集 | FR-14 | ステップの上下移動は、空行があれば行番号のみを移動し、ステップがあれば入れ替える | SHOULD | ボタン操作で空きセルへ移動可能 |
| 接続 | FR-15 | コネクタの折れ曲がり位置をドラッグで調整できる | SHOULD | 中央制御点を表示し手動レイアウトを可能にする |
| 接続 | FR-16 | コネクタの開始/終端マーカー種別とサイズを変更できる | SHOULD | 矢印・ドット・非表示を選択可能 |
| レイアウト | FR-17 | レーンの高さはステップ行数に合わせて自動調整される | SHOULD | 空行を含めた行数に基づき高さを算出 |
| 接続 | FR-18 | コネクタラベルに任意テキストを設定できる | SHOULD | 50文字以内、改行可能 |

## 6. 非機能要件
- **パフォーマンス**: 100ステップ程度のダイアグラムでもスムーズに操作可能であること。
- **可用性**: 主要ブラウザ（Chrome／Edge最新）での動作を保証する。
- **保守性**: TypeScriptで型定義を揃え、Zustandストアへの変更は監査ログと履歴管理を通す。
- **ユーザビリティ**: マウス操作主体で直感的なUIにし、日本語UIテキストを提供する。
- **拡張性**: Mermaidバージョン変更やステップ種別追加に対応できる構造にする。

## 7. 制約・前提条件
- 開発環境: Node.js 18以上、npm 9以上。
- 依存ライブラリ: React Flow, Mermaid, Zustand, Tailwind, html-to-image, nanoid。
- ブラウザ上でのローカルファイル操作（ダウンロード）のみを想定し、サーババックエンドは持たない。
- Undo/Redoはブラウザセッション内のみに限定される。

## 8. 成果物
- Next.jsアプリケーション本体と関連ライブラリコード。
- 自動テスト（Vitest・Playwright）およびMermaidサンプル `specs/`。
- 本ドキュメントを含む設計・運用資料（`docs/`）。

## 9. 更新・運用ポリシー
- 仕様追加・バグ修正時には本ドキュメントの該当要件を更新する。
- 実装と要件の乖離が発生した場合は、Issueテンプレートに沿って差分を記録する。
- 定期的にMermaid出力仕様と監査ログフォーマットをレビューし、互換性を確認する。
