# Feature Specification: スイムレーン図作成アプリ

**Feature Branch**: `001-swimlane-nextjs`  
**Created**: 2024-XX-XX  
**Status**: Draft  
**Input**: ユーザー要望: "スイムレーン図作成専用のアプリ。Next.jsが望ましい"

## User Scenarios & Testing *(mandatory)*

### User Story 1 - スイムレーン図をドラッグ操作で作成 (Priority: P1)

ITコンサルタントとして、ドラッグ＆ドロップ操作でレーンとステップが自動整列されたスイムレーン図をすぐ作成したい。

**Why this priority**: システム化検討に必要な基本資料作成の中心機能で、他機能の前提となる。

**Independent Test**: 空のキャンバスからレーン追加・ステップ配置・整列確認までを通しで操作し、PNGプレビューで整列具合をチェックできる。

**Acceptance Scenarios**:

1. **Given** 空のキャンバス、**When** レーンを追加すると、**Then** レーンが等間隔に水平配置される。
2. **Given** 複数ステップをレーンへドラッグ、**When** ドロップすると、**Then** ステップ間隔が自動調整され縦横が揃う。
3. **Given** 任意ステップのラベル編集、**When** 保存すると、**Then** その変更が即座にキャンバスへ反映される。

---

### User Story 2 - Mermaidでの再利用 (Priority: P1)

ITコンサルタントとして、作成した図をMermaid記法の`.md`に書き出し、後日インポートして再編集したい。

**Why this priority**: DBを持たない構成での再編集手段となり、資料の再利用性を確保するため。

**Independent Test**: 図面をMermaid `.md`としてエクスポートし、同ファイルを再インポートして初期状態と一致するか確認する。

**Acceptance Scenarios**:

1. **Given** 編集済み図、**When** Mermaidエクスポートを実行すると、**Then** レーン・ステップ・接続が記述された`.md`が取得できる。
2. **Given** 出力した`.md`ファイル、**When** アプリでインポートすると、**Then** 元のレーン構成・ラベル・配置が再現される。

---

### User Story 3 - PNGエクスポート (Priority: P2)

ITコンサルタントとして、完成した図をPNG画像で出力し、提案資料へ貼り付けたい。

**Why this priority**: Mermaidに慣れていない関係者向けに資料を配布する際に必要なため。

**Independent Test**: 図面からPNGをエクスポートし、A4資料に貼り付けても文字が判読できるか確認する。

**Acceptance Scenarios**:

1. **Given** 編集済み図、**When** PNGエクスポートを実行すると、**Then** 図全体が欠けずに画像化される。
2. **Given** 出力したPNG、**When** 資料に配置すると、**Then** 主要テキストが判読できる解像度を保持している。

---

### Edge Cases

- Mermaidインポート時に構文エラーがあれば、エラー内容を表示し元データを保持する。
- レーン数・ステップ数が多い場合にも描画崩れが無いようスクロールやズームを提供する。
- ブラウザタブを閉じようとした際、保存せず離脱するなら警告を表示する。
- 監査ログが高速操作でも漏れなく記録され、ダウンロード時に破損しない。

## Requirements *(mandatory)*

### Functional Requirements

- **FR-001**: Next.js (App Router) + TypeScript でスイムレーン編集キャンバスを提供する。
- **FR-002**: レーン・ステップ・結線をドラッグ＆ドロップで配置し、縦型カラム（列）ベースで自動整列する。
- **FR-003**: 編集内容をMermaid記法の`.md`ファイルとしてエクスポートできる。
- **FR-004**: Mermaid `.md`ファイルをインポートして図面を再現し、そのまま再編集できる。
- **FR-005**: 図面をPNG画像としてクライアント側で生成・ダウンロードできる。
- **FR-006**: 操作履歴の監査ログをセッション内で蓄積し、JSON等の形式でダウンロードできる。
- **FR-007**: レーン/ステップの名称・色・説明などの属性が編集できる。
- **FR-008**: 編集状態をブラウザストレージ（LocalStorage等）へ一時保存できる（任意）。
- **FR-009**: ステップを行単位でドラッグ＆ドロップまたはUIボタンで上下入れ替えできる。
- **FR-010**: 条件分岐（菱形）、開始／終了（ラウンド）などステップ種別を新規追加および既存ステップから変更できる。
- **FR-011**: レーンパネル・ステップパネルを開閉でき、編集エリアはブラウザ高さいっぱいで表示される。
- **FR-012**: レーン内の並び順に応じてステップ間を矢印コネクタで自動連結する。

### Key Entities

- **SwimlaneDiagram**: レーン配列、ステップ配列、接続情報を保持する図全体モデル。
- **Lane**: 名前、順序、担当、カラー等のメタデータを持つ水平レーン。
- **Step**: ラベル、説明、所属レーン、座標を持つ作業ステップ。
- **AuditEntry**: 操作種別、対象、メタデータ、タイムスタンプを保持する監査ログ項目。

## Success Criteria *(mandatory)*

- **SC-001**: 初回ユーザーが15分以内に0→1でスイムレーン図を完成できる。
- **SC-002**: Mermaidエクスポート→インポートの往復検証で、90%以上のテストケースで完全一致する。
- **SC-003**: PNG出力画像がA4資料相当で文字判読可能な解像度（約300dpi）を維持する。
- **SC-004**: 監査ログが連続10操作以上でも漏れなく記録される。
- **SC-005**: ドラッグ操作後の整列処理が500ms以内に完了する。
